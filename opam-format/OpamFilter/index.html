<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>OpamFilter (opam-format.OpamFilter)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><header><nav><a href="../index.html">Up</a> â€“ package <a href="../index.html">opam-format</a></nav><h1>Module <code>OpamFilter</code></h1><p>Formulas on variables, as used in opam files build scripts</p></header><dl><dt id="val-to_string"><a href="#val-to_string" class="anchor"></a><code><span class="keyword">val </span>to_string : <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> string</code></dt><dd><p>Pretty-print</p></dd></dl><dl><dt id="val-fold_down_left"><a href="#val-fold_down_left" class="anchor"></a><code><span class="keyword">val </span>fold_down_left : (<span class="type-var">'a</span> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <span class="type-var">'a</span>) <span>&#8209;&gt;</span> <span class="type-var">'a</span> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p>Folds on the tree of a filter</p></dd></dl><dl><dt id="val-map_up"><a href="#val-map_up" class="anchor"></a><code><span class="keyword">val </span>map_up : (<a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a>) <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a></code></dt><dd><p>Maps on all nodes of a filter, bottom-up</p></dd></dl><dl><dt id="val-variables"><a href="#val-variables" class="anchor"></a><code><span class="keyword">val </span>variables : <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> list</code></dt><dd><p>Returns all the variables appearing in a filter (including the ones within string interpolations</p></dd></dl><dl><dt id="type-env"><a href="#type-env" class="anchor"></a><code><span class="keyword">type </span>env</code><code><span class="keyword"> = </span><a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-variable_contents">OpamTypes.variable_contents</a> option</code><code></code></dt><dd><p>Type of filter environment.</p></dd></dl><dl><dt id="type-fident"><a href="#type-fident" class="anchor"></a><code><span class="keyword">type </span>fident</code><code><span class="keyword"> = </span><a href="../OpamTypes/index.html#type-name">OpamTypes.name</a> option list<span class="keyword"> * </span><a href="../OpamTypes/index.html#type-variable">OpamTypes.variable</a><span class="keyword"> * </span>(string<span class="keyword"> * </span>string) option</code><code></code></dt><dd><p>The type of filter idents with (optionally multiple) qualifying package names and optional string converter. Package name <code>None</code> encodes the self-reference <code>_</code></p></dd></dl><dl><dt id="val-map_variables"><a href="#val-map_variables" class="anchor"></a><code><span class="keyword">val </span>map_variables : (<a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a>) <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a></code></dt><dd><p>Maps on all variables appearing in a filter. The case where package variables are renamed differently and appear in a filter ident of the form <code>%{pkg1+pkg2:var}%</code> is not supported and raises <code>Invalid_argument</code>.</p></dd></dl><dl><dt id="val-map_variables_in_string"><a href="#val-map_variables_in_string" class="anchor"></a><code><span class="keyword">val </span>map_variables_in_string : (<a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a>) <span>&#8209;&gt;</span> string <span>&#8209;&gt;</span> string</code></dt><dd><p>Same limitation as <code>map_variables</code></p></dd></dl><dl><dt id="val-map_variables_in_fident"><a href="#val-map_variables_in_fident" class="anchor"></a><code><span class="keyword">val </span>map_variables_in_fident : (<a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a>) <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a> <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a></code></dt><dd><p>Does not handle rewriting the variables to different names (which can't be expressed with a <code>fident</code> anymore), and raises <code>Invalid_argument</code></p></dd></dl><dl><dt id="val-distribute_negations"><a href="#val-distribute_negations" class="anchor"></a><code><span class="keyword">val </span>distribute_negations : ?&#8288;neg:bool <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a></code></dt><dd><p>Distributes the negations to apply only to atoms</p></dd></dl><dl><dt id="val-expand_string"><a href="#val-expand_string" class="anchor"></a><code><span class="keyword">val </span>expand_string : ?&#8288;partial:bool <span>&#8209;&gt;</span> ?&#8288;default:(string <span>&#8209;&gt;</span> string) <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> string <span>&#8209;&gt;</span> string</code></dt><dd><p>Rewrites string interpolations within a string. <code>default</code> is applied to the fident string (e.g. what's between <code>%{</code> and <code>}%</code>) when the expansion is undefined. If unspecified, this raises <code>Failure</code>.</p><p>With <code>partial</code>, <code>default</code> defaults to the identity, and is otherwise expected to return a fident. In this case, the returned string is supposed to be expanded again (expansion results are escaped, escapes are otherwise kept). This makes the function idempotent</p></dd></dl><dl><dt id="val-unclosed_expansions"><a href="#val-unclosed_expansions" class="anchor"></a><code><span class="keyword">val </span>unclosed_expansions : string <span>&#8209;&gt;</span> ((int<span class="keyword"> * </span>int)<span class="keyword"> * </span>string) list</code></dt><dd><p>Returns the (beginning, end) offsets and substrings of any unclosed <code>%{</code> expansions</p></dd></dl><dl><dt id="val-eval"><a href="#val-eval" class="anchor"></a><code><span class="keyword">val </span>eval : ?&#8288;default:<a href="../OpamTypes/index.html#type-variable_contents">OpamTypes.variable_contents</a> <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-variable_contents">OpamTypes.variable_contents</a></code></dt><dd><p>Computes the value of a filter. May raise <code>Failure</code> if <code>default</code> isn't provided</p></dd></dl><dl><dt id="val-eval_to_bool"><a href="#val-eval_to_bool" class="anchor"></a><code><span class="keyword">val </span>eval_to_bool : ?&#8288;default:bool <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> bool</code></dt><dd><p>Like <code>eval</code> but casts the result to a bool. Raises <code>Invalid_argument</code> if not a valid bool and no default supplied.</p></dd></dl><dl><dt id="val-opt_eval_to_bool"><a href="#val-opt_eval_to_bool" class="anchor"></a><code><span class="keyword">val </span>opt_eval_to_bool : <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> option <span>&#8209;&gt;</span> bool</code></dt><dd><p>Same as <code>eval_to_bool</code>, but takes an option as filter and returns always <code>true</code> on <code>None</code>, <code>false</code> when the filter is <code>Undefined</code>. This is the most common behaviour for using &quot;filters&quot; for filtering</p></dd></dl><dl><dt id="val-eval_to_string"><a href="#val-eval_to_string" class="anchor"></a><code><span class="keyword">val </span>eval_to_string : ?&#8288;default:string <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> string</code></dt><dd><p>Like <code>eval</code> but casts the result to a string</p></dd></dl><dl><dt id="val-partial_eval"><a href="#val-partial_eval" class="anchor"></a><code><span class="keyword">val </span>partial_eval : <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a></code></dt><dd><p>Reduces what can be, keeps the rest unchanged</p></dd></dl><dl><dt id="val-ident_of_var"><a href="#val-ident_of_var" class="anchor"></a><code><span class="keyword">val </span>ident_of_var : <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a></code></dt><dd><p>Wraps a full_variable into a fident accessor</p></dd></dl><dl><dt id="val-ident_of_string"><a href="#val-ident_of_string" class="anchor"></a><code><span class="keyword">val </span>ident_of_string : string <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a></code></dt><dd><p>A fident accessor directly referring a variable with the given name</p></dd></dl><dl><dt id="val-ident_value"><a href="#val-ident_value" class="anchor"></a><code><span class="keyword">val </span>ident_value : ?&#8288;default:<a href="../OpamTypes/index.html#type-variable_contents">OpamTypes.variable_contents</a> <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-variable_contents">OpamTypes.variable_contents</a></code></dt><dd><p>Resolves a filter ident. Like <code>eval</code>, may raise Failure if no default is provided</p></dd></dl><dl><dt id="val-ident_string"><a href="#val-ident_string" class="anchor"></a><code><span class="keyword">val </span>ident_string : ?&#8288;default:string <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a> <span>&#8209;&gt;</span> string</code></dt><dd><p>Like <code>ident_value</code>, but casts the result to a string</p></dd></dl><dl><dt id="val-ident_bool"><a href="#val-ident_bool" class="anchor"></a><code><span class="keyword">val </span>ident_bool : ?&#8288;default:bool <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="index.html#type-fident">fident</a> <span>&#8209;&gt;</span> bool</code></dt><dd><p>Like <code>ident_value</code>, but casts the result to a bool</p></dd></dl><dl><dt id="val-expand_interpolations_in_file"><a href="#val-expand_interpolations_in_file" class="anchor"></a><code><span class="keyword">val </span>expand_interpolations_in_file : <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-basename">OpamTypes.basename</a> <span>&#8209;&gt;</span> unit</code></dt><dd><p>Rewrites <code>basename</code>.in to <code>basename</code>, expanding interpolations</p></dd></dl><dl><dt id="val-commands"><a href="#val-commands" class="anchor"></a><code><span class="keyword">val </span>commands : <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-command">OpamTypes.command</a> list <span>&#8209;&gt;</span> string list list</code></dt><dd><p>Processes filters evaluation in a command list: parameter expansion and conditional filtering</p></dd></dl><dl><dt id="val-single_command"><a href="#val-single_command" class="anchor"></a><code><span class="keyword">val </span>single_command : <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-arg">OpamTypes.arg</a> list <span>&#8209;&gt;</span> string list</code></dt><dd><p>Process a simpler command, without filters</p></dd></dl><dl><dt id="val-commands_variables"><a href="#val-commands_variables" class="anchor"></a><code><span class="keyword">val </span>commands_variables : <a href="../OpamTypes/index.html#type-command">OpamTypes.command</a> list <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> list</code></dt><dd><p>Extracts variables appearing in a list of commands</p></dd></dl><dl><dt id="val-of_formula"><a href="#val-of_formula" class="anchor"></a><code><span class="keyword">val </span>of_formula : (<span class="type-var">'a</span> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a>) <span>&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../OpamTypes/index.html#type-generic_formula">OpamTypes.generic_formula</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a></code></dt><dd><p>Converts a generic formula to a filter, given a converter for atoms</p></dd></dl><dl><dt id="val-filter_formula"><a href="#val-filter_formula" class="anchor"></a><code><span class="keyword">val </span>filter_formula : ?&#8288;default_version:<a href="../OpamTypes/index.html#type-version">OpamTypes.version</a> <span>&#8209;&gt;</span> ?&#8288;default:bool <span>&#8209;&gt;</span> <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filtered_formula">OpamTypes.filtered_formula</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-formula">OpamTypes.formula</a></code></dt><dd><p>Resolves the filter in a filtered formula, reducing to a pure formula.</p><p><code>default</code> is the assumed result for undefined filters. If a version filter doesn't resolve to a valid version, the constraint is dropped unless <code>default_version</code> is specified.</p><p>May raise, as other filter functions, if <code>default</code> is not provided and filters don't resolve.</p></dd></dl><dl><dt id="val-partial_filter_formula"><a href="#val-partial_filter_formula" class="anchor"></a><code><span class="keyword">val </span>partial_filter_formula : <a href="index.html#type-env">env</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filtered_formula">OpamTypes.filtered_formula</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filtered_formula">OpamTypes.filtered_formula</a></code></dt><dd><p>Reduces according to what is defined in <code>env</code>, and returns the simplified formula</p></dd></dl><dl><dt id="val-string_of_filtered_formula"><a href="#val-string_of_filtered_formula" class="anchor"></a><code><span class="keyword">val </span>string_of_filtered_formula : <a href="../OpamTypes/index.html#type-filtered_formula">OpamTypes.filtered_formula</a> <span>&#8209;&gt;</span> string</code></dt><dt id="val-variables_of_filtered_formula"><a href="#val-variables_of_filtered_formula" class="anchor"></a><code><span class="keyword">val </span>variables_of_filtered_formula : <a href="../OpamTypes/index.html#type-filtered_formula">OpamTypes.filtered_formula</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-full_variable">OpamTypes.full_variable</a> list</code></dt><dt id="val-filter_deps"><a href="#val-filter_deps" class="anchor"></a><code><span class="keyword">val </span>filter_deps : build:bool <span>&#8209;&gt;</span> post:bool <span>&#8209;&gt;</span> ?&#8288;test:bool <span>&#8209;&gt;</span> ?&#8288;doc:bool <span>&#8209;&gt;</span> ?&#8288;dev:bool <span>&#8209;&gt;</span> ?&#8288;default_version:<a href="../OpamTypes/index.html#type-version">OpamTypes.version</a> <span>&#8209;&gt;</span> ?&#8288;default:bool <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filtered_formula">OpamTypes.filtered_formula</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-formula">OpamTypes.formula</a></code></dt><dd><p>Resolves the build, post, test, doc, dev flags in a filtered formula (which is supposed to have been pre-processed to remove switch and global variables). <code>default</code> determines the behaviour on undefined filters, and the function may raise if it is undefined. If a constraint resolves to an invalid version, it is dropped, or replaced with <code>default_version</code> if specified. If test, doc or dev are unspecified, they are assumed to be filtered out already and encountering them will raise an assert.</p></dd></dl><dl><dt id="val-simplify_extended_version_formula"><a href="#val-simplify_extended_version_formula" class="anchor"></a><code><span class="keyword">val </span>simplify_extended_version_formula : <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <a href="../OpamTypes/index.html#type-filter_or_constraint">OpamTypes.filter_or_constraint</a> <a href="../OpamFormula/index.html#type-formula">OpamFormula.formula</a> <span>&#8209;&gt;</span> <a href="../OpamTypes/index.html#type-filter">OpamTypes.filter</a> <a href="../OpamTypes/index.html#type-filter_or_constraint">OpamTypes.filter_or_constraint</a> <a href="../OpamFormula/index.html#type-formula">OpamFormula.formula</a> option</code></dt><dd><p>Like <code>OpamFormula.simplify_version_formula</code>, but on filtered formulas (filters are kept unchanged, but put in front)</p></dd></dl></body></html>